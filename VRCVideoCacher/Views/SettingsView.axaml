<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:VRCVideoCacher.ViewModels"
             xmlns:models="using:VRCVideoCacher.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             x:Class="VRCVideoCacher.Views.SettingsView"
             x:DataType="vm:SettingsViewModel">

    <ScrollViewer>
        <StackPanel Spacing="20" Margin="10">
            <!-- Header -->
            <Grid ColumnDefinitions="*, Auto, Auto">
                <TextBlock Text="Settings" FontSize="24" FontWeight="Bold"/>
                <Button Grid.Column="1" Command="{Binding ResetToDefaultsCommand}" Margin="0,0,10,0">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <mi:MaterialIcon Kind="Undo" Width="16" Height="16"/>
                        <TextBlock Text="Reset"/>
                    </StackPanel>
                </Button>
                <Button Grid.Column="2" Command="{Binding SaveSettingsCommand}" Classes="accent">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <mi:MaterialIcon Kind="ContentSave" Width="16" Height="16"/>
                        <TextBlock Text="Save"/>
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Status Message -->
            <TextBlock Text="{Binding StatusMessage}"
                       IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                       Foreground="#81C784"/>

            <!-- Server Settings -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <TextBlock Text="Server Settings" FontWeight="SemiBold" FontSize="16"/>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Web Server URL"/>
                        <TextBox Text="{Binding WebServerUrl}" Watermark="http://localhost:9696"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Download Settings -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <TextBlock Text="Download Settings" FontWeight="SemiBold" FontSize="16"/>

                    <StackPanel Spacing="5">
                        <TextBlock Text="yt-dlp Path"/>
                        <TextBox Text="{Binding YtdlPath}" Watermark="Utils\yt-dlp.exe"/>
                    </StackPanel>

                    <CheckBox IsChecked="{Binding YtdlUseCookies}" Content="Use YouTube Cookies (browser extension)"/>
                    <CheckBox IsChecked="{Binding YtdlAutoUpdate}" Content="Auto-update yt-dlp, FFmpeg, and Deno"/>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Additional yt-dlp Arguments"/>
                        <TextBox Text="{Binding YtdlAdditionalArgs}" Watermark="Optional arguments"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Preferred Dub Language (e.g., 'de' for German)"/>
                        <TextBox Text="{Binding YtdlDubLanguage}" Watermark="Leave empty for original"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Download Delay (seconds)"/>
                        <NumericUpDown Value="{Binding YtdlDelay}" Minimum="0" Maximum="60" Increment="1"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Cache Settings -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <TextBlock Text="Cache Settings" FontWeight="SemiBold" FontSize="16"/>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Cache Path (leave empty for default)"/>
                        <TextBox Text="{Binding CachedAssetPath}" Watermark="Default: CachedAssets folder"/>
                    </StackPanel>

                    <CheckBox IsChecked="{Binding CacheYouTube}" Content="Cache YouTube Videos"/>

                    <StackPanel Spacing="5" IsVisible="{Binding CacheYouTube}">
                        <TextBlock Text="Max YouTube Resolution"/>
                        <ComboBox ItemsSource="{Binding ResolutionOptions}" SelectedItem="{Binding CacheYouTubeMaxResolution}"/>
                    </StackPanel>

                    <StackPanel Spacing="5" IsVisible="{Binding CacheYouTube}">
                        <TextBlock Text="Max Video Length (minutes)"/>
                        <NumericUpDown Value="{Binding CacheYouTubeMaxLength}" Minimum="1" Maximum="600" Increment="10"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Max Cache Size (GB, 0 = unlimited)"/>
                        <NumericUpDown Value="{Binding CacheMaxSizeInGb}" Minimum="0" Maximum="1000" Increment="1" FormatString="0.#"/>
                    </StackPanel>

                    <CheckBox IsChecked="{Binding CachePyPyDance}" Content="Cache PyPyDance Videos"/>
                    <CheckBox IsChecked="{Binding CacheVRDancing}" Content="Cache VRDancing Videos"/>
                </StackPanel>
            </Border>

            <!-- Custom Domains -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <StackPanel>
                        <TextBlock Text="Custom Domain Caching" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Text="Cache videos from custom domains" Foreground="#888" FontSize="12"/>
                    </StackPanel>

                    <CheckBox IsChecked="{Binding CacheCustomDomainsEnabled}" Content="Enable Custom Domain Caching"/>

                    <StackPanel Spacing="15" IsVisible="{Binding CacheCustomDomainsEnabled}">
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="Domains to Cache" VerticalAlignment="Center"/>
                            <Button Grid.Column="1" Command="{Binding AddCacheCustomDomainCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <mi:MaterialIcon Kind="Plus" Width="16" Height="16"/>
                                    <TextBlock Text="Add Domain"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <ItemsControl ItemsSource="{Binding CacheCustomDomains}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:EditableString">
                                    <Grid ColumnDefinitions="*, Auto" Margin="0,5">
                                        <TextBox Grid.Column="0" Text="{Binding Value}" Watermark="example.com"/>
                                        <Button Grid.Column="1" Margin="5,0,0,0"
                                                Command="{Binding $parent[ItemsControl].((vm:SettingsViewModel)DataContext).RemoveCacheCustomDomainCommand}"
                                                CommandParameter="{Binding}">
                                            <mi:MaterialIcon Kind="Delete" Width="16" Height="16"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Clear Cache on Exit -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <StackPanel>
                        <TextBlock Text="Clear Cache on Exit" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Text="Automatically delete cached videos when VRCVideoCacher closes" Foreground="#888" FontSize="12"/>
                    </StackPanel>

                    <CheckBox IsChecked="{Binding ClearYouTubeCacheOnExit}" Content="Clear YouTube cache on exit"/>
                    <CheckBox IsChecked="{Binding ClearPyPyDanceCacheOnExit}" Content="Clear PyPyDance cache on exit"/>
                    <CheckBox IsChecked="{Binding ClearVRDancingCacheOnExit}" Content="Clear VRDancing cache on exit"/>

                    <StackPanel Spacing="10" IsVisible="{Binding CacheCustomDomainsEnabled}" Margin="0,10,0,0">
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="Custom Domains to Clear on Exit" VerticalAlignment="Center"/>
                            <Button Grid.Column="1" Command="{Binding AddClearCustomDomainOnExitCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <mi:MaterialIcon Kind="Plus" Width="16" Height="16"/>
                                    <TextBlock Text="Add"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <ItemsControl ItemsSource="{Binding ClearCustomDomainsOnExit}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:EditableString">
                                    <Grid ColumnDefinitions="*, Auto" Margin="0,5">
                                        <TextBox Grid.Column="0" Text="{Binding Value}" Watermark="example.com"/>
                                        <Button Grid.Column="1" Margin="5,0,0,0"
                                                Command="{Binding $parent[ItemsControl].((vm:SettingsViewModel)DataContext).RemoveClearCustomDomainOnExitCommand}"
                                                CommandParameter="{Binding}">
                                            <mi:MaterialIcon Kind="Delete" Width="16" Height="16"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Game Patching -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <TextBlock Text="Game Patching" FontWeight="SemiBold" FontSize="16"/>

                    <CheckBox IsChecked="{Binding PatchVRC}" Content="Patch VRChat"/>
                    <CheckBox IsChecked="{Binding PatchResonite}" Content="Patch Resonite"/>
                </StackPanel>
            </Border>

            <!-- Updates & Startup -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <TextBlock Text="Updates &amp; Startup" FontWeight="SemiBold" FontSize="16"/>

                    <CheckBox IsChecked="{Binding AutoUpdate}" Content="Auto-update VRCVideoCacher"/>
                    <CheckBox IsChecked="{Binding VrcxAutoStart}"
                              Content="Start with VRCX (Windows only)"
                              IsVisible="{Binding IsVrcxInstalled}"
                              ToolTip.Tip="Automatically launch VRCVideoCacher when VRCX starts"/>
                </StackPanel>
            </Border>

            <!-- Advanced Settings -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <StackPanel>
                        <TextBlock Text="Advanced Settings" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Text="For power users only - modify at your own risk" Foreground="#f0ad4e" FontSize="12"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="AVPro Override"/>
                        <TextBlock Text="Force browser impersonation mode (true) or disable it (false)" Foreground="#888" FontSize="12"/>
                        <ComboBox ItemsSource="{Binding AvproOverrideOptions}" SelectedItem="{Binding AvproOverride}"/>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="yt-dlp Arguments Override (replaces Additional Args when set)"/>
                        <TextBox Text="{Binding YtdlArgsOverride}" Watermark="Leave empty to use Additional Arguments"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Pre-Cache URLs -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <StackPanel>
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="Pre-Cache URLs" FontWeight="SemiBold" FontSize="16"/>
                            <Button Grid.Column="1" Command="{Binding AddPreCacheUrlCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <mi:MaterialIcon Kind="Plus" Width="16" Height="16"/>
                                    <TextBlock Text="Add"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                        <TextBlock Text="Videos to automatically download when VRCVideoCacher starts" Foreground="#888" FontSize="12"/>
                    </StackPanel>

                    <ItemsControl ItemsSource="{Binding PreCacheUrls}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:EditableString">
                                <Grid ColumnDefinitions="*, Auto" Margin="0,5">
                                    <TextBox Grid.Column="0" Text="{Binding Value}" Watermark="https://youtube.com/watch?v=..."/>
                                    <Button Grid.Column="1" Margin="5,0,0,0"
                                            Command="{Binding $parent[ItemsControl].((vm:SettingsViewModel)DataContext).RemovePreCacheUrlCommand}"
                                            CommandParameter="{Binding}">
                                        <mi:MaterialIcon Kind="Delete" Width="16" Height="16"/>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Blocked URLs -->
            <Border Background="#2d2d2d" CornerRadius="8" Padding="20">
                <StackPanel Spacing="15">
                    <Grid ColumnDefinitions="*, Auto">
                        <TextBlock Text="Blocked URLs" FontWeight="SemiBold" FontSize="16"/>
                        <Button Grid.Column="1" Command="{Binding AddBlockedUrlCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <mi:MaterialIcon Kind="Plus" Width="16" Height="16"/>
                                <TextBlock Text="Add"/>
                            </StackPanel>
                        </Button>
                    </Grid>

                    <ItemsControl ItemsSource="{Binding BlockedUrls}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:EditableString">
                                <Grid ColumnDefinitions="*, Auto" Margin="0,5">
                                    <TextBox Grid.Column="0" Text="{Binding Value}"/>
                                    <Button Grid.Column="1" Margin="5,0,0,0"
                                            Command="{Binding $parent[ItemsControl].((vm:SettingsViewModel)DataContext).RemoveBlockedUrlCommand}"
                                            CommandParameter="{Binding}">
                                        <mi:MaterialIcon Kind="Delete" Width="16" Height="16"/>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>

    <UserControl.Styles>
        <Style Selector="Button.accent">
            <Setter Property="Background" Value="#1DB954"/>
        </Style>
    </UserControl.Styles>
</UserControl>
